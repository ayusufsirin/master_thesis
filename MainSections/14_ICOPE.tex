\section{3 BOYUTTA SENSÖR FÜZYONU} \label{ICOPE}

Çalışmanın bu kısmında, hata metriği olarak Hausdorff Mesafesi'ni kullandık. Sensör füzyonu yöntemleri olarak ise, bir önceki kısımda denediğimiz yöntemlerin 3 boyuttaki karşılıkları denebilecek yöntemlerin performansını inceledik. Veriseti olarak ise MulRan\cite{mulran} veri setini kullandık. Veri setinde yapılan tek değişiklik, 5 Hz olan GPS frekansının 1 Hz olarak alt örnekleminin alınmasıdır. Bu uygulamanın nedeni Kalman filtresinin performansını düşürerek LiDAR Odometrisinin etkisini daha net gözlemleyebilmektir.

\subsection{Tek Yönlü Hausdorff Mesafesi}\label{sec:bidir_hd}

Orjinal Hausdorff Mesafesi metriği iki nokta bulutunda bulunan her nokta için hesaplanır. Ancak bizim problemimizde, ölçümden gelen nokta bulutu seyrekken (sparse), haritadan gelen nokta bulutu yoğundur (dense). Bu durum sonucunda, eğer harita nokta bulutundan ölçüm nokta bulutuna olan uzaklık hesaplandığı durumda, kenar yada düzlemin dış kısımlarında kalan noktalar için ölçümde tek bir karşılık bulunabilecek ve bu durum, kestirim başarıs  yerine, örnekleme sıklığından kaynaklı yüksek değerler elde edilmesine neden olacaktır. Bu durum Şekil (\ref{fig:bidir_hd})'de gösterilmiştir. 

\begin{figure}[!hb]
    \centering
    \includegraphics[width=0.5\linewidth]{Figures/bidir_hd.png}
    \caption[Aynı doğru üzerinde bulunan Harita ve Ölçüm kenar nokta bulutları üzerinden Hausdorff Mesafesinin hesaplanması.]{Aynı doğru üzerinde bulunan Harita (mavi) ve Ölçüm (Kırmızı) kenar nokta bulutları üzerinden Hausdorff Mesafesinin hesaplanması. Eğer Harita nokta bulutundan Ölçüm nokta bulutuna doğru olan uzaklık hesaba katılırsa, bu durum sonucu kestirim başarımından çok örneklem sıklığına bağımlı hale getirecektir.}
    \label{fig:bidir_hd}
\end{figure}

Ayrıca, hem problem uzayını küçültüp işlemi hızlandırmak, hem de daha uygun karşılıklılık bulmak adına, yüzey ve kenar nokta bulutları için Hausdorff Mesafesi ayrı ayrı olarak hesaplayıp ve daha büyük değeri Denklem (\ref{eq:HD_result})'deki gibi sonuç olarak kabul ettik. Genel olarak yüzey nokta bulutları, kenar nokta bulutlarından daha büyüktür. Eğer yüzey ölçüm nokta bulutu boyutu \(n\), referans nokta bulutu boyutu \(m\) ise,  Hausdorff Mesafesi için hesaplamada zaman karmaşıklığımız (time complexity) \(O(n\log m)\) olacaktır.

Hausdorff Mesafesini ölçmek için önce güncel yüzey ve kenar nokta bulutları \(\mathcal{H}_k^L\) ve \(\mathcal{E}_k^L\)'nin orijinini, güncel pozisyon kestirimi \(\widehat{T}_k^0\)'ye taşıdık. Burada güncel nokta bulutları \(\mathcal{H}_k^L\) ve \(\mathcal{E}_k^L\)'den güncel harita nokta bulutları \(\mathcal{H}_m^{map}\) ve \(\mathcal{E}_m^{map}\)'ye göre tek yönlü Hausdorff mesafesi Denklem (\ref{eq:HD_surf}) ve (\ref{eq:HD_edge})'deki gibi hesapladık.

\begin{equation}\label{eq:HD_surf}
d_{\widehat{\mathcal{H}}_k^{map}}({\widehat{\mathcal{H}}_k^{map}},\mathcal{H}_m^{map}) = 
{\sup\limits_{l\in\widehat{\mathcal{H}}_k^{map}}}\left\{{\inf\limits_{m\in\mathcal{H}_m^{map}}} \lVert l-m \rVert\right\}
\end{equation}
\begin{equation}\label{eq:HD_edge}
d_{\widehat{\mathcal{E}}_k^{map}}({\widehat{\mathcal{E}}_k^{map}},\mathcal{E}_m^{map}) = 
{\sup\limits_{l\in\widehat{\mathcal{E}}_k^{map}}}\left\{{\inf\limits_{m\in\mathcal{E}_m^{map}}} \lVert l-m \rVert\right\}
\end{equation}
\begin{equation}\label{eq:HD_result}
    \textit{Var}(\widehat{T}_k^{map}) = I_{3 \times 3}\times\max(d_{\widehat{\mathcal{H}}_k^{map}},d_{\widehat{\mathcal{E}}_k^{map}}) 
\end{equation}

Bu metriğin karşılaştığı problem, aykırı verilerden çok fazla etkilenmesidir. Bu aykırı veri, yanlış bir ölçüm olabileceği gibi, üzerinden ilk defa ölçüm alınan bir cisim olabilir. Referans nokta bulutunda bu cisme dair bir ölçüm bulunmadığı için, bu noktanın en yakın uzaklığı, normalden çok daha fazla olacaktır. Bu nedenle Hausdorff Mesafesi'ni hesaplanan noktanın 5 metre uzağında, referans nokta bulutunda en az 4 nokta bulunmuyorsa, bu sonuç hesap dışı bırakılmıştır. Bu değerlerin seçilmesinin nedeni, çalışmada referans algoritma olarak kullanılan LeGO-LOAM\cite{legoloam} algoritmasının karşılıklılık bulurken yine bu değerleri kullanmasıdır. Bu nedenle bu değerler sisteme efektif olarak yeni parametre eklememektedir.

\subsection{Kullanılan Metotlar}

Kısım (\ref{Background})'de de anlatıldığı üzere, metriğimizin yeterince düşük yanlılık altında, MSE ve dolayısıyla varyans değeri ile ilintili olmasını bekliyoruz. Tüm bu varsayımları zaten yaptığımız için, hipotezimizi sağlayan bir metrik bulduğumuz durumda en düşük MSE'yi sağlayacak etkin kestirici (efficient estimator) MVUE (Minimum Variance Unbiased Estimator - En Küçük Varyanslı Yansız Kestirici) modelidir. Bu nedenle bu kısımda yaptığımız kestirimleri bu modeli kullanarak yaptık. Buradaki tek farkımız, pozisyon değerleri arasındaki çapraz varyans değerlerinin pozisyonların kendi varyans değerlerine göre çok daha küçük olması nedeni ile kestirime katkıları minimal seviyededir. HEsaplamaları kolaylaştırmak adına, burada kovaryans matrislerinin sadece çapraz elemanlarını alıp, diğer değerlerini 0 olarak kullandık.

Veri setindeki IMU ve GPS verisini, INS sensörleri için geliştirilmiş hazır bir Kalman Filtresi\cite{insfilterasync} kullanarak birleştirdik (\(T_K\)). LiDAR odometrisi (\(T_L\)) üretmek için ise, LeGO-LOAM\cite{legoloam} algoritmasının, Kısım (\ref{sec:hausdorff_dist})'de anlattığımız Hausdorff Mesafesi yöntemi ile varyans kestirimi yapacak şekilde modifiye ettiğimiz bir versiyonunu\cite{repo:loam_cov_est} kullandık. Yapılan bu değişiklikler Kısım (\ref{sec:bidir_hd})'de detaylı olarak anlatılmıştır. Ayrıca algoritmada opsiyonel olarak bulunan IMU entegrasyonu ve döngü kapama becerilerini devre dışı bıraktık. Daha sonra elde edilen bu iki odometri verisini Denklem (\ref{eq:global_alpha}) ve (\ref{eq:delta_alpha})'de verilen Global Ortalama ve Dönüşüm Ortalama metotlarını kullanarak birleştirdik. Son olarak, bu iki metodun da avantajlarınnı kullanan Düzeltilmiş Ortalama metodunda, Global Ortalama ve Dönüşüm Ortalama metotlarının sonuçları üzerinden hesapladık. Ayrıca, elde edilen sonuçları karşılaştırabilmek amacıyla (\ref{eq:dinamik_alpha2})'de verilen Dinamik \(\alpha\) metoduna benzer Optimal Ortalama metodu ile sensör verilerinin doğrusal kombinasyonu ile elde edilmesi mümkün en başarılı kestirim değerini bulduk.

\subsubsection{Optimal Ortalama}
Optimal Ortalama metodu çevrimdışı bir metottur ve bir önceki kısımdaki gibi yine elde edilen sonuçları karşılaştırabileceğimiz bir referans olması amacı ile eklenmiştir. Ancak burada 3 Boyutta çalışmamız nedeni ile tam doğru sonucu almamız her zaman mümkün değildir. Bu nedenle bu metot var olan sensör verisinin doğrusal ortalaması ile alınabilinecek optimum sonucu vermektedir. Bu durumun nedeni Şekil (\ref{fig:x_opt})'de anlatılmıştır.
\begin{figure}[!htb]
    \centering
    \includegraphics[width=0.5\linewidth]{Figures/Xopt.png}
    \caption[\(X_\textbf{Opt}\)'un Hesaplanması]{\(X_\textbf{Opt}\)'un Hesaplanması: 2 sensörden alınan pozisyon verisinin doğrusal ağırlıklı ortalaması ile elde edilebilinecek tüm kestirimler, uzayda bu iki nokta arasında kalan doğru parçasının üzerinde bulunmaktadır. Bu noktalar arasındaki en başarılı sonuca \(X_\textbf{Opt}\) dersek, bu noktadan referans pozisyana çizilecek doğru, kestirim doğrusuna dik olmak zorundadır\cite{p3loam}.}
    \label{fig:x_opt}
\end{figure}

LiDAR, Kalman, Optimal ve Referans kestirimini sırası ile \(X_\text{LiDAR}\), \(X_\text{Kalman}\), \(X_\text{Opt}\) ve \(X_\text{Ref}\) olarak tanımlarsak, \(X_\text{Opt}\) değerini Denklem (\ref{eq:alpha_opt}) ve (\ref{eq:X_opt})'deki gibi elde edebiliriz.

\begin{equation}\label{eq:alpha_opt}
\begin{split}
f(k) &= \frac{\overrightarrow{X_\text{LiDAR}(k)X_\text{Ref}(k)} \cdot \overrightarrow{X_\text{LiDAR}(k)X_\text{Kalman}}(k)}{|\overrightarrow{X_\text{LiDAR}(k)X_\text{Kalman}(k)}|^2} \\
\alpha(k) &=
    \begin{cases}
    0, & \text{if } f(k) < 0, \\
    1, & \text{if } f(k) > 1, \\
    f(k), & \text{if } 0 \leq f(k) \leq 1.
    \end{cases}
\end{split}
\end{equation}

\begin{equation}\label{eq:X_opt}
X_\text{Opt} =  X_\text{LiDAR}(k) + \alpha(k) \cdot \overrightarrow{X_\text{LiDAR}(k)X_\text{Kalman}(k)}
\end{equation}

\subsubsection{Global Ortalama}
Global Ortalama metodunda LiDAR odometrisinin pozisyon varyansını Denklem (\ref{eq:var_update_series})'e benzer şekilde elde ettik. Yapılan hesaplamayı basitleştirmek amacı ile, Kalman Filtresi kovaryans matrisinin çapraz elemanlarını, karşılık geldikleri yöndeki LiDAR odometrisi ağırlığı, LiDAR odometrisi kovaryans matrisinin çapraz elemanlarını, karşılık geldikleri yöndeki Kalman Filtresi ağırlığı olarak belirledik. Burada anlatılan işlem Denklem (\ref{eq:gobal_weight}) ve (\ref{eq:gobal_calc})'de görülebilir. Yapılan bu işlem, kestirim sonucunu, ayrıtları birim vektör olan ve iki kestirim sonucunun cisim köşegenini belirttiği dikdörtgenler prizmasının içinde kalan uzay ile sınırlar. Bu uzay Şekil (\ref{fig:global_span})'de görülebilir. Şekildeki cisim köşegeni, Optimal Ortalama metodunda bahsedilen kestirim doğrusuna denk gelmektedir.

\begin{equation}\label{eq:gobal_weight}
\mathrm{A}(k) = (diag(P_\text{LiDAR}(k))+diag(P_\text{Kalman}(k)))^{-1} \times diag(P_\text{LiDAR}(k))
\end{equation}
\begin{equation}\label{eq:gobal_calc}
X_\text{Global}(k) =  \mathrm{A}(k) \times X_\text{Kalman}(k) + (1-\mathrm{A}(k)) \times X_\text{LiDAR}(k)
\end{equation}

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{Figures/global_ortalama_span.png}
    \caption[Global Ortalama metodu sonuç uzayı]{Global Ortalama metodu sonuç uzayı Siyah prizma ile, Optimal Ortalama metodunun sonuç doğrusu ise Kırmızı çizgi ile gösterilmiştir.}
    \label{fig:global_span}
\end{figure}

\subsubsection{Dönüşüm Ortalama}
Dönüşüm Ortalama metodunda LiDAR odometrisinin dönüşüm varyansı için o pozisyonda hesaplanan Hausdorff Mesafesini kullandık.  Kullandığımız hazır Kalman Filtresi iki tahmin arasındaki dönüşümün varyansını vermemektedir, bu nedenle buu değerin ayrıca hesaplanması gerekir. 

Bu değeri elde etmenin bir yolu her tahminden sonra filtreyi tekrar ilklendirmek (initialization) olabilir. Ancak bu yöntem, Kalman Filtresi için yapılacak her işlemi tekrardan yapmayı gerektirir ve tahmin kovaryansının hesaplandığı adımın hesaplamada zaman karmaşıklığı, \(n\) boyutlu durum vektörü için \(O(n^3)\) olduğu düşünüldüğünde hızlı bir süreç değildir. Ayrıca, bu işlem her tahmin sonrası Kalman Filtresinin ve ölçümlerin tüm durum ve kovaryans değerlerinin bilinmesini gerektirir ve Kalman Filtresi ile sonuç üreten INS sensörlerinin kullanıldığı durumda, bu değerlerin hepsi her zaman mevcut değildir. Bu nedenle, Kalman Filtresinin dönüşüm varyansını elde etmek için yeni bir metot önerdik. Bu metotta yaptığımız işlem kısaca, Kalman Filtresinin dönüşüm varyansı için bir alt limit ve bir üst limit belirleyip bunların ortalamasını almaktır.  

\paragraph{Kalman Filtresi dönüşüm varyansı alt limiti}

Kalman Filtresi'nin dönüşüm varyansı için alt limit belirlerken Denklem (\ref{eq:var_update_series})'deki mantığı ters konvolüsyon kullanarak tekrarladık. Bunun için \(k-1\) anındaki Kalman Filteresi tahmini \(P_{k-1}^0\)'i \(P_k^0\)'ye taşıyan dönüşüm \(T_{K}(k)\) olsun (\(P_{k-1}^0 \ast T_{K}(k) = P_k^0\)). Bu durumda \(T_{K}(k)\) ters konvolüsyonla Denklem (\ref{eq:tf_inv_conv}) gibi hesaplanabilir. 

\begin{equation}\label{eq:tf_inv_conv}
    T_{K}(k) = {P_{k-1}^0}^{-1} \ast P_k^0 + G_k
\end{equation}

Burada \(G_k\) 0 ortalama değere sahip bir beyaz gürültüdür. Kovaryans matrisleri kesin pozitif (positive definite) oldukları için bu gürültü varyansını 0 kabul ettiğimizde elde edeceğimiz sonuç, dönüşüm varyansı için bir alt limit olacaktır. Ancak bu çıkarma işlemi sonucunda elde edilen matrisin yarı-kesin pozitif (positive semi-definite) olduğundan emin olmamız gerekir. Bunun için Özayrışım (Eigendecomposition) ile elde edeceğimiz negatif özdeğerleri (eigenvalue) 0'a eşitleyebiliriz. Böylece varyans için alt limiti Denklem (\ref{eq:DNLKF_Pest_wrt_body})'deki gibi elde edebiliriz.
\begin{align}
    Q\Lambda Q^T &=P_k^0 -{P_{k-1}^0} \nonumber \\
    \Lambda^+ &= max(\Lambda,0) \nonumber\\
    P_{(k)}^{k-1} &> R_{k-1}^TQ\Lambda^+Q^TR_{k-1} = R_{k-1}^T(P_k^0 -{P_{k-1}^0})^+R_{k-1}\label{eq:DNLKF_Pest_wrt_body}
\end{align}

\paragraph{Kalman Filtresi dönüşüm varyansı üst limiti} \label{sec:kf_upper_limit}

Kalman Filtresi'nin dönüşüm varyansı üst limitin belirlemek için ise Ayrık Doğrusal Olmayan Kalman Filtresi'nin denklemlerini (Denklem (\ref{eq:DNLKF_start})-(\ref{eq:DNLKF_end}))\cite{cmu_ekf} kullanabiliriz. 

Eğer Ölçüm adımında hiç bir ölçüm alınmadığını var sayarsak, ki bu durumu sonsuz varyansa sahip bir ölçüm olarak kabul edebiliriz (\(R_{k-1}\approx \inf\)), Denklem (\ref{eq:DNLKF_calcK})'deki \(K\) değeri \(0\) olur. Bunun sonucunda ise Denklem (\ref{eq:DNLKF_correctP}) sadeleşerek \(P_{k-1|k-1} =  P_{k-1|k-2}\) formunu alır. Bu sonucu Denklem (\ref{eq:DNLKF_predictP})'e yerleştirdiğimizde ise Denklem (\ref{eq:DNLKF_Prelation})'i elde ederiz.

\begin{align}
\textbf{Ölçüm Adımı:} \nonumber \\
H_{k-1} &= \left. \frac{\partial \mathbf{h}(\mathbf{x}, t_{k-2})}{\partial \mathbf{x}} \right|_{\mathbf{x} = \hat{\mathbf{x}}_{k-1|k-2}}\label{eq:DNLKF_start} \\
K_{k-1} &= P_{k-1|k-2} H_{k-1}^T \left( H_{k-1} P_{k-1|k-2} H_{k-1}^T + R_{k-1} \right)^{-1}\label{eq:DNLKF_calcK} \\
\hat{\textbf{X}}_{k-1|k-1} &= \hat{\textbf{X}}_{k-1|k-2} + K_{k-1} \left[ \hat{\textbf{Z}}_{k-1} - \mathbf{h}\left(\hat{\mathbf{x}}_{k-1|k-2}, k-1 \right) \right] \\
P_{k-1|k-1} &= \left( I - K_{k-1} H_{k-1} \right) P_{k-1|k-2}\label{eq:DNLKF_correctP}\\
\nonumber \\
\textbf{Tahmin Adımı:} \nonumber \\
\hat{\textbf{X}}_{k|k-1} &= \textbf{f}\left(\hat{\textbf{X}}_{k-1|k-1},k-1 \right) \\
P_{k|k-1} &= F_{k-1}P_{k-1|k-1}F_{k-1}^T + Q \label{eq:DNLKF_predictP} \\
F_{k-1} &=\left. \frac{\partial\textbf{f}\left(\mathbf{x},t \right)}{\partial \mathbf{x}} \right|_{\mathbf{x}=\hat{\textbf{X}}_{{k-1}|{k-1}}}\label{eq:DNLKF_end}\\
\end{align}
\begin{equation}\label{eq:DNLKF_Prelation}
    P_{k|k-1} = F_kP_{k-1|k-2}F_k^T + Q
\end{equation}

3 Boyutlu Euclid uzayında holonomik hareket yapan bir araç için state vektörümüz \\ \(\mathbf{x}=\left[\begin{smallmatrix} x_{(1\times3)},\quad \dot{x}_{(1\times3)},\quad \ddot{x}_{(1\times3)}\end{smallmatrix}\right]^T\) olur. Eğer bu state vektörünün State transition matrisini pozisyon (\(F_p\)), hız (\(F_v\)) ve ivme (\(F_a\)) için parçalara bölersek ve pozisyon, hız ve ivme durumları arasındaki çapraz varyansları 0 kabul edersek Denklem (\ref{eq:state_transitipn_pos}) ve (\ref{eq:P_no_cross})'i elde ederiz. Bu sonuçları Denklem (\ref{eq:DNLKF_Prelation})' içine yerleştirirsek pozisyon varyansı için Denklem (\ref{eq:DNLKF_Pest})'i elde ederiz.
\begin{align}
    F&=\begin{bmatrix} F_{p(3\times9)}\\ F_{v(3\times9)}\\ F_{a(3\times9)}\end{bmatrix} \nonumber \\
    F_{p(k)} &= \begin{bmatrix} I_{(3\times3)},dt\times I_{(3\times3)},\frac{dt^2}{2}\times I_{(3\times3)}\end{bmatrix}, \quad dt = t(k)-t(k-1)\label{eq:state_transitipn_pos}\\
    P &=  \begin{bmatrix} P_{p(3\times3)} \quad 0_{(3\times3)}\quad 0_{(3\times3)}\\ 0_{(3\times3)} \quad P_{v(3\times3)} \quad 0_{(3\times3)}\\ 0_{(3\times3)} \quad 0_{(3\times3)} \quad P_{a(3\times3)}\end{bmatrix}\label{eq:P_no_cross}\\
    P_{p(k|k-1)} &= P_{p(k-1|k-2)} + dt^2\times P_{v(k-1|k-2)} + \frac{dt^4}{4}\times P_{a(k-1|k-2)} + Q \nonumber\\
    P_{p(k|k-1)} - P_{p(k-1|k-2)} &= dt^2\times P_{v(k-1|k-2)} + \frac{dt^4}{4}\times P_{a(k-1|k-2)} + Q \label{eq:DNLKF_Pest}
\end{align}

Denklem (\ref{eq:DNLKF_Pest})'deki varyans değerleri dünya koordinat sistemini referans almaktadır, bu nedenle bunları gövde koordinat sistemine dönüştürürsek, Denklem (\ref{eq:DNLKF_Pest_up_wrt_body})' elde ederiz. Bu sonuç, iki tahmin adımı arasında hiçbir ölçüm yapılmadığı takdirde elde edeceğimiz sonuçtur. IMU ölçümleri 100 Hz, LiDAR ölçümleri ise 10 Hz de alındığı için bu aralıkta bir ölçüm alınacaktır. Bu nedenle bu sonucu, dönüşümün varyansı için bir üst limit olarak kullanabiliriz.

\begin{equation}
    P_{p(k)}^{k-1} < {\widehat{R}_{k-1}^{0^T}}\left(dt^2\times P_{v(k-1|k-2)} + \frac{dt^4}{4}\times P_{a(k-1|k-2)} + Q \right)\widehat{R}_{k-1}^0 \label{eq:DNLKF_Pest_up_wrt_body}
\end{equation}

Alt ve üst limitini bildiğimiz dönüşüm varyansını, bu iki limitin ortalamasını alarak hesaplayabiliriz. Biz çalışmamızda ortalamayı alırken eşit ağırlık kullanmayı tercih ettik.
Bu işlem sonucunda ise dönüşüm varyans değeri \({\sigma_k^{k-1}}^2\)'yi, Denklem (\ref{eq:gauss_rot_var_update})'den yola çıkarak, Denklem (\ref{eq:kalman_tf_cov})'deki gibi hesaplayabiliriz. Alt limit matrisinin yarı-kesin pozitif olması durumunda kesin pozitif bir matris ile ortalamasının kesin pozitif olacağı 2 boyutlu matris için Ekler'de  kanıtlanmıştır. 

\begin{footnotesize}
\begin{equation}\label{eq:kalman_tf_cov}
    P^{k-1}(k) \approx \frac{R(k-1)^T\left(\left(P_k^0 -{P_{k-1}^0}\right)^++\left(dt^2\times P_{v(k-1|k-2)} + \frac{dt^4}{4}\times P_{a(k-1|k-2)} + Q \right)\right)R(k-1)}{2}
\end{equation}
\end{footnotesize}

Önerdiğimiz metodun hesaplamada zaman karmaşıklığı, matris çarpımı nedeniyle hala \(O(n^3)\) olmakla birlikte, buradaki \(n\) değeri her zaman 3'tür.

İki sensör için de dönüşüm kestirimlerinin varyansı bulunduktan sonra, iki kestirimin yaptığı öteleme, Denklem (\ref{eq:diff_weight}), (\ref{eq:diff_calc1}) ve (\ref{eq:diff_calc3}) kullanılarak hesaplanır. Başlangıçta Kalman Filtresi'nin oryantasyon verisi için de yukarıdakine benzer bir yöntem izlemekle birlikte, Kalman Filtresi'nin oryantasyon varyans değerleri, Hausdorf Mesafesi sonucundan 5 büyüklük kertesi küçük (\(10^{-5}\)) çıktığı için, işlemi hızlandırmak adına, Oryantasyon değeri olarak doğrudan Kalman Filtresi'nin sonucunu referans aldık.

\begin{equation}\label{eq:diff_weight}
\mathrm{A}(k) = (diag(P_\text{LiDAR}^{k-1}(k))+diag(P_\text{Kalman}^{k-1}(k)))^{-1} \times diag(P_\text{LiDAR}^{k-1}(k))
\end{equation}
\begin{small}
\begin{equation}\label{eq:diff_calc1}
\Delta X_\text{Dönüşüm}(k) = \Delta X_\text{Dönüşüm}(k-1) \times \left[ \mathrm{A}(k) \times \Delta X_\text{Kalman}^{k-1}(k) + (1-\mathrm{A}(k)) \times \Delta X_\text{LiDAR}^{k-1}(k) \right]
\end{equation}
\end{small}
\begin{equation}\label{eq:diff_calc3}
    X_\text{Dönüşüm}(k) = X_\text{Dönüşüm}(k-1) + R_\text{Kalman}^{k-1}\Delta X_\text{Dönüşüm}(k)
\end{equation}

\subsubsection{Düzeltilmiş Ortalama}

Bu metot Global ortalama ve Dönüşüm ortalama metotlarının bir birleşimi olarak düşünülebilir. Buradaki amaç, hem Global ortalama metodu gibi mutlak hatası düşük, hem de Dönüşüm ortalama metodu gibi görece hatası düşük bir pozisyon kestirimi yapabilmektir.

Kısım (\ref{sec:icope_results})'de veriler üzerinden daha detaylı anlatılacağı üzere, Dönüşüm ortalama metodunun görece hatasının en yüksek olduğu zaman, Global ortalama metodunun mutlak hatasının en düşük olduğu zamana dek gelmektedir ve bu da Kalman Filtresi'nin GPS verisi ile doğrulama yapmasından sonraki ilk füzyon zamanıdır(\(n\)). Bu durumdan istifade ederek tam olarak bu zamandaki Global Ortalama pozisyon kestirimi \(T_G(n)\) ile bu zamandan beri Dönüşüm Ortalama metodunun yaptığı toplam dönüşüm kestirimini (\(T_D^{-1}(n)T_D(k)\)) Denklem (\ref{eq:corrected_weighting})'deki gibi Düzeltilmiş Ortalama kestirimi \(T_C(k)\) elde etmek için kullanabiliriz.

\begin{equation}\label{eq:corrected_weighting}
    T_C(k) = T_G(n)T_D^{-1}(n)T_D(k), \quad n<k
\end{equation}

Bu denklem, LOAM algoritmasının haritalama adımı sonucunu, LiDAR Odometrisi sonucunu düzeltmek için kullanan denklemin (Denklem (\ref{loam_tf_update})) aynısıdır. Zaten bu fikrin ilham kaynağı da bu denklem olmuştur.

\subsection{Sonuçlar}\label{sec:icope_results}

Dönüşüm Ortalama ve Global Ortalama metotlarının ağırlıklarını incelediğimizde, buradaki değerlerin gürültü bir sinyale benzer bir karakteristiğe sahip olduğunu gözlemledik.

 % Subfigure (e) gain plots
\begin{figure}[!htb]
    \centering
    \begin{minipage}{0.45\textwidth}
        \centering
    \includegraphics[trim=0.85cm 6.2cm 0.85cm 6.2cm, clip,width=1\linewidth]{ICOPE_results/riverside3/Global_weights.pdf}
    \end{minipage}%
    \hspace{0.05\textwidth}
    \begin{minipage}{0.45\textwidth}
        \centering
        \includegraphics[trim=0.85cm 6.2cm 0.85cm 6.2cm, clip,width=1\linewidth]{ICOPE_results/riverside3/Dönüşüm_weights.pdf}
    \end{minipage}
    \caption{Riverside 3 Veriseti için Global ve Dönüşüm Ortalama Metotlarında kullanılan LiDAR Sensörü Ağırlıkları}
\end{figure}

Sensör ağırlıklarının gürültülü görünümünün nedenini anlamak için bu sinyallere Lomb-Scargle periodogramı\cite{lomb_scargle} ile frekans analizi yaptık. Lomb-Scargle periodogramı, düzensiz zaman örneklemeli verilerde sinyallerin frekans spektrumunu analiz etmek için kullanılan, Fourier dönüşümüne dayalı bir yöntemdir. Analiz sonucunda, Şekil (\ref{fig:r3_spec}), (\ref{fig:dcc_spec})'de görüleceği üzere bu karakteristiğin gücünün 1 Hz ve harmoniklerindeki frekanslarda toplanmıştır. Bu değer GPS sensörünün frekansına denk gelmektedir. Daha detaylı inceleme için GPS sensör verilerinin farklı oranlarda alt örneklerini aldığımızda ise bu frekans değerlerinin aynı oranlarda değiştiğini gözlemledik. 

     % Subfigure (f) gain plots
\begin{figure}[!htb]
    \centering
    \begin{minipage}{0.75\textwidth}
        \centering
    \includegraphics[trim=0.85cm 6.2cm 0.85cm 6.2cm, clip,width=1\linewidth]{ICOPE_results/riverside3/Global_spectrum.pdf}
    \end{minipage} \\
    \begin{minipage}{0.75\textwidth}
        \centering
        \includegraphics[trim=0.9cm 6.2cm 1cm 6.2cm, clip,width=1\linewidth]{ICOPE_results/riverside3/Dönüşüm_spectrum.pdf}
    \end{minipage}
    \caption{Riverside 3 Veriseti için Global ve Dönüşüm Ortalama Metotlarında kullanılan LiDAR Sensörü Ağırlıklarının Spektrumu}
    \label{fig:r3_spec}
\end{figure}

Bu durumun nedeni, LiDAR sensörü ağırlığının Kalman Filtresi'nin pozisyon varyansı ile pozitif korelasyona sahip olmasıdır ve Kalman Filtresi'nin pozisyon varyansı doğrudan pozisyon ölçümü yapan tek sensör olan GPS ölçümü sonrası azalmaktadır. Böylece sistem, GPS sensörü ölçümü ardından Kalman Filtresi'nin ağırlığını arttırmaktadır. Bu andan sonra yapılan ilk tahminde pozisyon varyansı artmakta ve Kalman Filtresi'nin ağırlığı azalmaktadır ve bu döngü GPS sensörünün frekansında tekrarlanmaktadır.

Global ortalama metodu ağırlığı ile GPS frekansının ilişkisi doğrudan anlaşılabilir. Dönüşüm ortalama metodunda ise, varyans kestiriminin üst limiti hız, ivme varyansları ve proses gürültüsüne bağlıdır ve bu durumdan etkilenmez. Öte yandan alt limitin değeri ölçüm sonrası 0'a düşebilmektedir. Bu da GPS düzeltmesi sonrası Kalman Filtresi'nin pozisyon kestiriminde yapılan güncellemeyi daha büyük bir ağırlıkla ortalamaya yansıtmaktadır. Bu dönüşüm sonucu pozisyon düzeltmesini de içerdiği için, gerçekte yapılan hareketle farklılıklar göstermekte ve o andaki görece pozisyon hatasını arttırmaktadır. Öte yandan bu düzeltme, kestirimin mutlak hatasını düşürmektedir. Sonuç olarak elimizde bulunan iki metottan Dönüşüm Ortalamanın en başarısız olduğu an, Global Ortalamanın en başarılı olduğu ana denk gelmektedir. Bu durumdan istifade etmek için Düzeltilmiş ortalama metodunu önerdik.

Tablo (\ref{tab:r3_ape}) ve (\ref{tab:r3_rpe})'e baktığımızda altı farklı sonuç görmekteyiz. Bunlardan Kalman Filtresi ve LiDAR sensörlerden elde edilen kestirim sonuçlarını, Optimal Ortalama ise bu iki sensör sonucunun doğrusal kombinasyonu ile yapılabilinecek en iyi kestirim sonucunu vermekte ve referans görevi görmektedir. Global Ortalama özellikle mutlak hatada, Dönüşüm Ortalama özellikle görece hatada, Düzeltilmiş Ortalama ise iki hata metriğinde de başarılı sonuç vermesini beklediğimiz sensör füzyonu sonuçlarıdır.

% Subfigure (a) ape table    
\begin{table}[!htb]
    \centering
    % Table
    \begin{tabular}{|l|r|r|r|r|r|r|}
        \hline
        \textbf{} & \textbf{RMSE} & \textbf{Ort.} & \textbf{Medyan} & \textbf{Std.} & \textbf{Min} & \textbf{Max} \\ \hline
        \textbf{Optimal Ortalama} & 5.96 & 5.31 & 5.19 & 2.71 & 0.0 & 26.65 \\ \hline
        \textbf{Global Ortalama} & 6.41 & 5.79 & 5.55 & 2.77 & 0.13 & 27.68 \\ \hline
        \textbf{Kalman Filtresi} & 6.73 & 5.88 & 5.59 & 3.28 & 0.15 & 35.52 \\ \hline
        \textbf{Düzeltilmiş Ortalama} & 6.07 & 5.46 & 5.13 & 2.64 & 0.11 & 27.35 \\ \hline
        \textbf{LiDAR} & 357.36 & 284.94 & 232.19 & 215.68 & 1.05 & 982.52 \\ \hline
        \textbf{Dönüşüm Ortalama} & 129.29 & 116.06 & 124.0 & 56.97 & 1.18 & 223.24 \\ \hline
    \end{tabular}
    \caption[Riverside 3 Veriseti için Mutlak Hata Tablosu]{Riverside 3 Veriseti için Mutlak Hata Tablosu. Hatalar metre cinsinden verilmiştir.}\label{tab:r3_ape}
\end{table} %\vspace{1em} % Add vertical space between subfigures
    
\begin{table}[!h]% Subfigure (b) ape table  
\centering
    \begin{tabular}{|l|r|r|r|r|r|r|}
        \hline
        \textbf{} & \textbf{RMSE} & \textbf{Ort.} & \textbf{Medyan} & \textbf{Std.} & \textbf{Min} & \textbf{Max} \\ \hline
        \textbf{Optimal Ortalama} & 0.65 & 0.28 & 0.12 & 0.59 & 0.0 & 13.12 \\ \hline
        \textbf{Global Ortalama} & 1.16 & 0.59 & 0.23 & 0.99 & 0.0 & 16.89 \\ \hline
        \textbf{Kalman Filtresi} & 0.99 & 0.39 & 0.15 & 0.91 & 0.0 & 16.03 \\ \hline
        \textbf{Düzeltilmiş Ortalama} & 1.11 & 0.54 & 0.24 & 0.96 & 0.0 & 13.82 \\ \hline
        \textbf{LiDAR} & 0.68 & 0.14 & 0.03 & 0.66 & 0.0 & 11.54 \\ \hline
        \textbf{Dönüşüm Ortalama} & 0.99 & 0.45 & 0.22 & 0.88 & 0.0 & 15.27 \\ \hline
    \end{tabular}
    \caption[Riverside 3 Veriseti için Görece Hata Tablosu]{Riverside 3 Veriseti için Görece Hata Tablosu. Hatalar 15 metre yer değiştirme için hesaplanan yüzdesel yer değiştirme hatasına denk gelmektedir.}\label{tab:r3_rpe}
\end{table}

Hataların ölçümünü yapmak için, SLAM algoritmalarını değerlendirmek için oluşturulmuş evo\cite{evo} python paketini kullandık. Değerlendirme sırasında paket içerisinde bulunan Umayema'nın hizalama algoritmasını\cite{umeyama}, ilk 90 derecelik dönüşün ardından gelen düz yolun bitimine kadar olan bölümü hizalayacak şekilde kullandık. Bu hizalamanın nedeni, herhangi bir pozisyon ölçümü almayan LiDAR odometrisinin, başlangıçtaki küçük bir açı farkından bile çok fazla etkileniyor olmasıdır. Ancak bu hizalamanın kestirim başarısına olan etkisini limitlemek için, hizalamayı 3 boyutta düzgün hizalama yapabilmek için gerekli minimum veri ile gerçekleştirdik. Bu veri de başlangıçtan itibaren yapılan ilk "L" şeklindeki harekete denk gelmektedir. Son olarak bu hizalama, Optimal Ortalama kestiriminin başarısını düşürdüğü için, bu kestirimin hata ölçümünü hizalama yapmadan aldık.

Mutlak hata tablosuna (\ref{tab:r3_ape}) göre, Optimal Ortalama yöntemi, beklendiği üzere tüm metriklerde en düşük hatayı göstermiştir. Özellikle Düzeltilmiş Ortalama yöntemi, Optimal Ortalama'ya en yakın sonuçları elde etmiş, hem RMSE hem de standart sapma değerleri açısından diğer yöntemlere göre daha başarılı olmuştur. Kalman Filtresi, Global Ortalama ve Dönüşüm Ortalama yöntemleriyle kıyaslandığında, nispeten daha yüksek hata oranlarına sahiptir. LiDAR sonuçları ise, muzdarip olduğu hata birikimi nedeni ile açık ara en yüksek hata değerlerini göstermiştir.

Görece hata tablosunda (\ref{tab:r3_rpe}), Optimal Ortalama yöntemi yine tüm metriklerde en iyi sonuçları sağlamıştır. Dikkat çekici bir şekilde, LiDAR görece hata açısından daha düşük bir ortalama değere sahiptir. Kalman Filtresi ve Dönüşüm Ortalama yöntemleri, görece hata açısından benzer sonuçlar sunarken, Düzeltilmiş Ortalama bunların gerisinde kalmıştır.

%Sonuç olarak, Optimal Ortalama yöntemi tüm karşılaştırmalarda referans niteliğini korurken, Düzeltilmiş Ortalama yöntemi, gerçek zamanlı uygulanabilirliğiyle oldukça başarılı bir alternatif sunmaktadır. Kalman Filtresi ve Dönüşüm Ortalama yöntemleri de makul bir performans sergilerken, LiDAR'ın tek başına kullanımı, yüksek hata oranları nedeniyle önerilmemektedir. Bu sonuçlar, önerilen füzyon yöntemlerinin, sensörlerin bireysel performanslarını iyileştirerek daha güvenilir kestirimler sağladığını göstermektedir.

     % Subfigure (c) pozisyon plots
\begin{figure}[!htb]
    \centering
%    \begin{minipage}{0.45\textwidth}
%        \centering
%    \includegraphics[width=1\linewidth]{ICOPE_results/riverside3/3B_plot.pdf}
%    \end{minipage}%
%    \hspace{0.05\textwidth}
    \begin{minipage}{0.85\textwidth}
        \centering
        \fbox{\includegraphics[trim=0.85cm 6.2cm 0.85cm 6.2cm, clip,width=1\linewidth]{ICOPE_results/riverside3/2BT_plot.pdf}}
    \end{minipage}
    \caption{Riverside 3 Veriseti Sonucunun Kuşbakışı Görüntüsü}\label{fig:r3_map}
\end{figure}

\begin{figure}[!htb]
     % Subfigure (d) pozisyon error plots
        \centering
        \begin{minipage}{0.45\textwidth}
            \centering
        \includegraphics[width=1\linewidth]{ICOPE_results/riverside3/traj_out/ape_comparison_plot_raw.png}
        \end{minipage}%
        \hspace{0.05\textwidth}
        \begin{minipage}{0.45\textwidth}
            \centering
            \includegraphics[width=1\linewidth]{ICOPE_results/riverside3/traj_out/rpe_comparison_plot_raw.png}
        \end{minipage}
        \caption{Riverside 3 Veriseti için Mutlak (sol) ve Görece (sağ) Pozisyon Hatası Sonuçları}\label{fig:r3_error}
\end{figure}

Kestirim sonuçları ve zamana bağlı kestirim hataları Şekil (\ref{fig:r3_map}) ve (\ref{fig:r3_error})'de görülebilir.

\include{ICOPE_results/riverside3/riverside3}
\include{ICOPE_results/DCC2/DCC2}

%Düzeltilmiş ortalama metodu ise riverside 3 ve DCC 2 verisetlerinde kaynak aldığı sensör verilerinden daha başarılı sonuç verebilmiştir. Bu başarının tüm verisetlerinde tekrarlanamamış olması kesin bir yargıya varmanın önüne geçmekle beraber, Hausdorff Mesafesi metriğinin bir potansiyeli olduğunu göstermektedir.  
