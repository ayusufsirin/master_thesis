flowchart TD
%% =========================================================
%%  High-contrast ROS architecture (bright panels)
%% =========================================================

%% ---------------- SUBSYSTEMS ----------------
subgraph SENSORS["Sensors"]
direction TB
camera_node["Stereo Camera <br/> Driver"]:::sensor_node
lidar_node["LiDAR Driver"]:::sensor_node
wheel_encoder["Wheel Encoder <br/> Driver"]:::sensor_node
imu_node["IMU Driver"]:::sensor_node
end
style SENSORS fill:#1e293b,stroke:#38bdf8,stroke-width:3px,color:#e5f3ff

subgraph PERCEPTION["Perception"]
direction TB
image_proc["Image Processing<br/>(stereo → depth)"]:::perception_node
lidar_upsample["LiDAR Upsample<br/>(odom-aided)"]:::perception_node
pg["PG Fusion Node"]:::perception_node
end
style PERCEPTION fill:#064e3b,stroke:#22c55e,stroke-width:3px,color:#ecfdf5

subgraph LOCALIZATION_G["Localization"]
direction TB
localization["Localization Node"]:::localization_node
end
style LOCALIZATION_G fill:#7c2d12,stroke:#f97316,stroke-width:3px,color:#fff7ed

subgraph CameraTopics["Camera Topics"]
direction LR
cam_rgb_left["/camera/rgb/left/image"]:::topic_camera
cam_rgb_right["/camera/rgb/right/image"]:::topic_camera
cam_info["/camera/rgb/info <br> $$f_x,f_y,c_x,c_y$$"]:::topic_camera
end

%% ---------------- TOPICS ----------------
%%subgraph TOPICS["ROS Topics"]
%%direction TB
cam_rgb_left["/camera/rgb/left/image"]:::topic_camera
cam_rgb_right["/camera/rgb/right/image"]:::topic_camera
cam_info["/camera/rgb/info"]:::topic_camera
cam_depth["/camera/depth/image <br> $$D_{\mathrm{ZED}}^{\mathrm{orig}}(v,u)$$"]:::topic_depth
cam_depth_info["/camera/depth/info <br> $$f_x,f_y,c_x,c_y$$"]:::topic_depth

lidar_pc["/lidar/point_cloud <br/> $$\mathcal{X}_k$$"]:::topic_lidar
lidar_pc_cum["/cumulative_origin_point_cloud <br/> $$\mathcal{Z}_k^{\text{cum}}$$"]:::topic_lidar

imu_data["/imu/data"]:::topic_odom
wheel_odom["/wheel/odom"]:::topic_odom
odom["/odom <br/> $$ (\mathbf{p}_k,\mathbf{q}_k) $$"]:::topic_odom

pg_depth["/pg/depth <br> $$\mathcal{P}_{\text{PG}}, D_{\text{PG}}(v,u)$$"]:::topic_fused
%%end
%%style TOPICS fill:#334155,stroke:#64748b,stroke-width:2px,color:#f8fafc

%% ---------------- TF ----------------
subgraph TF["TF Frames"]
direction TB
tf_map_odom["map → odom"]:::tf_frame
tf_odom_base["odom → base_link"]:::tf_frame
end
style TF fill:#4338ca,stroke:#a78bfa,stroke-width:3px,color:#f5f3ff

%% ---------------- FLOWS ----------------
camera_node --> CameraTopics --> image_proc
%%camera_node --> cam_rgb_right --> image_proc
%%camera_node --> cam_info --> image_proc

lidar_pc --> lidar_upsample

image_proc --> cam_depth --> pg
image_proc --> cam_depth_info --> pg

imu_node --> imu_data --> localization
wheel_odom --> localization
lidar_node --> lidar_pc --> localization
localization --> odom --> lidar_upsample
lidar_upsample --> lidar_pc_cum --> pg

pg --> pg_depth

wheel_encoder --> wheel_odom

localization -.-> tf_map_odom
localization -.-> tf_odom_base

%% ---------------- STYLES ----------------
%% Nodes
classDef sensor_node fill:#020617,stroke:#38bdf8,stroke-width:2px,color:#e0f2fe,rx:10,ry:10;
classDef perception_node fill:#022c22,stroke:#22c55e,stroke-width:2px,color:#dcfce7,rx:10,ry:10;
classDef localization_node fill:#3b1d0f,stroke:#f97316,stroke-width:2px,color:#ffedd5,rx:10,ry:10;

%% Topics
classDef topic_camera fill:#e0f2fe,stroke:#0284c7,color:#0c4a6e,rx:8,ry:8;
classDef topic_depth fill:#dcfce7,stroke:#16a34a,color:#052e16,rx:8,ry:8;
classDef topic_lidar fill:#fef3c7,stroke:#f59e0b,color:#78350f,rx:8,ry:8;
classDef topic_odom fill:#ffe4e6,stroke:#e11d48,color:#881337,rx:8,ry:8;
classDef topic_fused fill:#ede9fe,stroke:#7c3aed,color:#2e1065,rx:8,ry:8;

%% TF
classDef tf_frame fill:#ddd6fe,stroke:#7c3aed,stroke-width:2px,color:#2e1065,rx:12,ry:12,stroke-dasharray:6 4;

%% Links
linkStyle default stroke:#9ca3af,stroke-width:2px
