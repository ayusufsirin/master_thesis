flowchart TB

%% ================== CONTEXT ====================
    subgraph external_inputs["External Inputs to Fusion Node"]
        direction LR
        lidar_pc_cum[("/lidar/point_cloud/cumulative")]:::topic
        cam_depth[("/camera/depth/image <br> $$D_{\text{ZED}}^{\text{orig}}$$")]:::topic
        cam_depth_info[("/camera/depth/info <br> $$f_x, f_y, c_x, c_y$$")]:::topic
        cam_rgb_left[("/camera/rgb/left/image")]:::topic
        odom[("/odom")]:::topic
    end

%% ================== FUSION NODE ====================
    subgraph fusion_node["Fusion Node (PG Algorithm)"]
        direction LR
    %% ---------- LIDAR PREPROCESSING ----------
        subgraph lidar_preproc["LiDAR Preprocessing"]
            direction TB
            lp_in["LiDAR PointCloud2 <br> (lidar_pc_cum)"]:::topic
            msg2pts_node["msg2pts() <br> ROS → CuPy XYZ"]:::stage
            cart2sph_node["cart_to_sph_pts() <br> $$(x,y,z) → (r, \theta, \phi)$$"]:::stage
            proj_node["cart_pts_to_depth_image() <br> Projection with <br> $$fx, fy, cx, cy$$"]:::stage
            D_L["LiDAR Depth Image <br> $$D_L(v,u)$$"]:::data
            lp_in --> msg2pts_node --> cart2sph_node --> proj_node --> D_L
        end

    %% ---------- ZED PREPROCESSING ----------
        subgraph zed_preproc["ZED Depth Preprocessing"]
            direction TB
            zed_in["ZED Depth Image <br> $$D_{\text{ZED}}^{\text{orig}}(v,u)$$"]:::topic
            mask_node["Invalid Mask <br> $$M(v,u) \triangleq (NaN / \pm \infty)$$"]:::stage
            inpaint_node["inpaint_depth_cupy_nanaware() <br> Iterative 4-neighbour fill"]:::stage
            D_ZED["Inpainted ZED Depth <br> $$D_{\text{ZED}}(v,u)$$"]:::data
            zed_in --> mask_node --> inpaint_node --> D_ZED
        end

    %% ---------- CROPPING & CONSISTENCY ----------
        subgraph crop_consistency["Cropping + ZED–LiDAR Consistency Filter"]
            direction TB
            crop_node["Crop to <br> $$\Omega_c$$ <br> (MORTAL_* parameters)"]:::stage
            D_ZED_c["$$D_{\text{ZED}}^c(v,u)$$"]:::data
            D_L_c["$$D_{\text{L}}^c(v,u)$$"]:::data
            consistency_node["$$|D_{\text{ZED}}^c - D_L^c| \leq \tau$$  <br> $$\therefore D_{\text{L}}^c(v,u) \neq NaN$$"]:::stage
            D_L_c_filt["Filtered LiDAR Crop <br> $$D_{\text{L}}^c, \text{filt}(v,u)$$"]:::data
            D_ZED --> crop_node --> D_ZED_c
            D_L --> crop_node --> D_L_c
            D_ZED_c --> consistency_node
            D_L_c --> consistency_node --> D_L_c_filt
        end

    %% ---------- FUSION RULE ----------
        subgraph fusion_rule["Depth Fusion Rule"]
            direction TB
            pg_crop["PG Crop <br> $$D_{\text{PG}}^c(v,u) = D_{\text{L}}^c, \text{filt}(v,u)$$"]:::stage
            pg_full["Full Fused Depth Map <br> $$D_{\text{PG}}(v,u)$$"]:::data
            mask_apply["Reapply Original Mask <br> $$M(v,u)=1 \rightarrow D_{\text{PG}}(v,u)=NaN$$"]:::stage
            D_L_c_filt --> pg_crop --> pg_full --> mask_apply
        end

    %% ---------- BACK-PROJECTION ----------
        subgraph backproj["Back-Projection to 3D Point Clouds"]
            direction TB
            to_cam_frame["Depth → Camera Frame <br> $$(X_{cam},Y_{cam},Z_{cam})$$"]:::stage
            axis_remap["Axis Remapping <br> $$(x^\prime,y^\prime,z^\prime) = (Z_{cam}, -X_{cam}, -Y_{cam})$$"]:::stage
            pc_pg["Fused Point Cloud <br> $$\mathcal{P}_{\text{PG}}$$"]:::data
            pc_zed["ZED Point Cloud <br> from $$D_{\text{ZED}}(v,u)$$"]:::data
            pc_zed_orig["ZED Original PC <br> from $$D_{\text{ZED}}^{\text{orig}}(v,u)$$"]:::data
            pc_vlp_dbg["LiDAR Debug PC <br> from $$D_{\text{L}}(v,u)$$"]:::data
            pg_full --> to_cam_frame --> axis_remap --> pc_pg
            D_ZED --> to_cam_frame --> pc_zed
            zed_in --> to_cam_frame --> pc_zed_orig
            D_L --> to_cam_frame --> pc_vlp_dbg
        end

    end
%% fusion_node

%% ================== WIRING EXTERNAL → INTERNAL ====================
    lidar_pc_cum --> lp_in
    cam_depth --> zed_in
    cam_depth_info --> proj_node
    cam_depth_info --> to_cam_frame
    cam_rgb_left --> fusion_node
    odom --> fusion_node
%% ================== OUTPUT TOPICS ====================
    pg_depth[("/pg/depth <br> $$D_{\text{PG}}(v,u)$$")]:::topic
    pg_fused_pc[("/pg/fused_point_cloud <br> $$\mathcal{P}_{\text{PG}}$$")]:::topic
    pg_zed_pc[("/pg/zed_point_cloud <br> from $$D_{\text{ZED}}$$")]:::topic
    pg_zed_orig_pc[("/pg/zed_original_point_cloud <br> from $$D_{\text{ZED}}^{\text{orig}}$$")]:::topic
    pg_vlp_debug_pc[("/pg/vlp_debug_point_cloud <br> from $$D_{\text{L}}$$")]:::topic
    pg_full --> pg_depth
    pc_pg --> pg_fused_pc
    pc_zed --> pg_zed_pc
    pc_zed_orig --> pg_zed_orig_pc
    pc_vlp_dbg --> pg_vlp_debug_pc
%% ================== STYLING ====================
    classDef stage fill: #3d85c6, stroke: #1c4587, color: #fff, rx: 6, ry: 6;
    classDef data fill: #f6b26b, stroke: #b45f06, color: #000, rx: 4, ry: 4;
    classDef topic fill: #ffe599, stroke: #b7b7b7, color: #000, rx: 4, ry: 4;
